(function(){var f,m,p,n,j,o,r;"undefined"!==typeof require?(f=require("underscore"),m=require("backbone"),exports=module.exports=m):(f=this._,m=this.Backbone);p=m.Model;n=m.Collection;j=p.prototype;r=/[\.\[\]]+/g;m.Many="Many";m.One="One";o=m.AssociatedModel=p.extend({relations:void 0,_proxyCalls:void 0,get:function(b){var a=j.get.call(this,b);return a?a:this.getAttr.apply(this,arguments)},set:function(b,a,c){var d,g,e,i,l=this;if(f.isObject(b)||b==null){d=b;c=a}else{d={};d[b]=a}if(!d)return this;
for(g in d){e||(e={});if(g.match(r)){b=q(g);a=f.initial(b);b=b[b.length-1];a=this.get(a);if(a instanceof o){a=e[a.cid]||(e[a.cid]={model:a,data:{}});a.data[b]=d[g]}}else{a=e[this.cid]||(e[this.cid]={model:this,data:{}});a.data[g]=d[g]}}if(e)for(i in e){a=e[i];this.setAttr.call(a.model,a.data,c)||(l=false)}else return this.setAttr.call(this,d,c);return l},setAttr:function(b,a){var c;a||(a={});if(a.unset)for(c in b)b[c]=void 0;this.relations&&f.each(this.relations,function(d){var c=d.key,e=d.relatedModel,
i=d.collectionType,l,j,k,h;if(b[c]){l=f.result(b,c);e&&f.isString(e)&&(e=eval(e));i&&f.isString(i)&&(i=eval(i));j=d.options?f.extend({},d.options,a):a;if(d.type===m.Many){if(i&&!i.prototype instanceof n)throw Error("collectionType must inherit from Backbone.Collection");if(l instanceof n){k=l;b[c]=k}else if(this.attributes[c]){this.attributes[c].reset(l,j);delete b[c]}else{k=i?new i:this._createCollection(e);k.add(l,j);b[c]=k}}else if(d.type===m.One&&e){k=l instanceof o?l:new e(l);b[c]=k}if((h=k)&&
!h._proxyCallback){h._proxyCallback=function(){return this._bubbleEvent.call(this,e,i,c,h,arguments)};h.on("all",h._proxyCallback,this)}}},this);return j.set.call(this,b,a)},_bubbleEvent:function(b,a,c,d,g){var e=g[0].split(":"),i=e[0],l=g[1],j=-1,k=d._proxyCalls,h;f.size(e)>1&&(h=e[1]);if(d instanceof n&&"change"===i&&l){var m=q(h),p=f.initial(m);(e=d.find(function(a){var b=a.get(m);return l===(b instanceof o||b instanceof n)?b:a.get(p)||a}))&&(j=d.indexOf(e))}h=c+(j!==-1?"["+j+"]":"")+(h?"."+h:
"");g[0]=i+":"+h;if(k){if(i=f.find(k,function(a,b){return h.indexOf(b,h.length-b.length)!==-1}))return this}else k=d._proxyCalls={};k[h]=true;if(g[0]==="change:"+c){if(d instanceof o)b=new b(d._previousAttributes);else{b=a?new a:this._createCollection(b);b.add(d._previousAttributes,relationOptions)}this._previousAttributes[c]=b}this.trigger.apply(this,g);h&&k&&delete k[h];return this},_createCollection:function(b){var a=b;f.isString(a)&&(a=eval(a));if(a&&a.prototype instanceof o){b=new n;b.model=
a}else throw Error("type must inherit from Backbone.AssociatedModel");return b},hasChanged:function(b){var a,c,d;if(!this.visitedHC){this.visitedHC=true;a=j.hasChanged.apply(this,arguments);if(!a&&this.relations)for(d=0;d<this.relations.length;++d){c=this.relations[d];if(c=this.attributes[c.key]){if(c instanceof n){c=c.filter(function(a){return a.hasChanged()===true});f.size(c)>0&&(a=true)}else a=c.hasChanged&&c.hasChanged();if(a)break}}delete this.visitedHC}return a},changedAttributes:function(b){var a,
c,d,g;if(!this.visited){this.visited=true;a=j.changedAttributes.apply(this,arguments);if(this.relations)for(g=0;g<this.relations.length;++g){c=this.relations[g];if(d=this.attributes[c.key])if(d instanceof n){d=f.filter(d.map(function(a){return a.changedAttributes()}),function(a){return!!a});f.size(d)>0&&(a[c.key]=d)}else d instanceof o&&d.hasChanged()&&(a[c.key]=d.toJSON())}delete this.visited}return!a?false:a},previousAttributes:function(){var b,a;b=j.previousAttributes.apply(this,arguments);this.relations&&
f.each(this.relations,function(c){a=b[c.key];b[c.key]=a?a.toJSON():void 0},this);return b},previous:function(b){return this.previousAttributes()[b]},toJSON:function(b){var a,c;if(!this.visited){this.visited=true;a=j.toJSON.apply(this,arguments);this.relations&&f.each(this.relations,function(d){var g=this.attributes[d.key];if(g){c=g.toJSON(b);a[d.key]=f.isArray(c)?f.compact(c):c}},this);delete this.visited}return a},clone:function(){return new this.constructor(this.toJSON())},getAttr:function(b){var a=
this,b=q(b),c,d;if(!(f.size(b)<1)){for(d=0;d<b.length;d++){c=b[d];if(!a)break;a=a instanceof n&&!isNaN(c)?a.at(c):a.attributes[c]}return a}}});var s=/[^\.\[\]]+/g,q=function(b){return b===""?[""]:f.isString(b)?b.match(s):b||[]}}).call(this);
