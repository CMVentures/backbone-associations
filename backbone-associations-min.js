(function(){var d,e;"undefined"===typeof window?(d=require("underscore"),e=require("backbone"),exports=module.exports=e):(d=window._,e=window.Backbone,exports=window);e.Many="Many";e.One="One";e.AssociatedModel=e.Model.extend({relations:void 0,set:function(c,b,g){var f,h;if(d.isObject(c)||c==null){f=c;g=b}else{f={};f[c]=b}g||(g={});if(f){if(g.unset)for(attr in f)f[attr]=void 0;this.relations&&d.each(this.relations,function(a){if(f[a.key]!=void 0){var b=!f||!f[a.key]?null:d.isFunction(f[a.key])?f[a.key]():
f[a.key];a.relatedModel&&d.isString(a.relatedModel)&&(a.relatedModel=eval(a.relatedModel));a.collectionType&&d.isString(a.collectionType)&&(a.collectionType=eval(a.collectionType));var c=false;if(a.type===e.Many){if(a.collectionType&&!a.collectionType.prototype instanceof e.Collection)throw Error("collectionType must inherit from Backbone.Collection");if(!this.attributes[a.key]){this.attributes[a.key]=a.collectionType?new a.collectionType:this._createCollection(a.relatedModel);c=true}if(b instanceof
e.Collection)b=b.models;this.attributes[a.key].reset(b,g)}else if(a.type==e.One&&a.relatedModel){if(this.attributes[a.key]){var i={},j=!this.attributes[a.key]||!this.attributes[a.key].defaults?null:d.isFunction(this.attributes[a.key].defaults)?this.attributes[a.key].defaults():this.attributes[a.key].defaults;d.each(this.attributes[a.key].attributes,function(a,c){!d.has(b,c)&&(i[c]=j?j[c]:void 0)});this.attributes[a.key].set(i,{silent:true})}else{if(b instanceof e.AssociatedModel)return;this.attributes[a.key]=
new a.relatedModel;c=true}this.attributes[a.key].set(b,g)}this.attributes[a.key].off("all");this.attributes[a.key].on("all",function(a){this.trigger(a,d.rest(arguments))},this);c&&this.trigger("change:"+a.key,g);!h&&(h=[]);d.indexOf(h,a.key)===-1&&h.push(a.key)}},this);if(h){b={};for(c in f)d.indexOf(h,c)===-1&&(b[c]=f[c])}else b=f;return e.Model.prototype.set.call(this,b,g)}},_createCollection:function(c){var b;if(c&&c.prototype instanceof e.AssociatedModel){b=new e.Collection;b.model=c}else throw Error("type must inherit from Backbone.AssociatedModel");
return b},toJSON:function(){var c=e.Model.prototype.toJSON.apply(this,arguments);this.relations&&d.each(this.relations,function(b){this.attributes[b.key]&&(c[b.key]=this.attributes[b.key].cid!==this.cid?this.attributes[b.key].toJSON():void 0)},this);return c},clone:function(){var c=e.Model.prototype.clone.apply(this,arguments);this.relations&&d.each(this.relations,function(b){if(this.attributes[b.key]){var d=c.attributes[b.key];if(d instanceof e.Collection){var f=b.collectionType?new b.collectionType:
this._createCollection(b.relatedModel);d.each(function(b){f.add(b.clone())});c.attributes[b.key]=f}else d instanceof e.Model&&(c.attributes[b.key]=d.clone())}},this);return c}})})();
