(function(){var e,d;"undefined"===typeof window?(e=require("underscore"),d=require("backbone"),exports=module.exports=d):(e=window._,d=window.Backbone,exports=window);d.Many="Many";d.One="One";d.AssociatedModel=d.Model.extend({relations:void 0,set:function(b,c,g){var f,h;if(e.isObject(b)||b==null){f=b;g=c}else{f={};f[b]=c}g||(g={});if(f){if(g.unset)for(attr in f)f[attr]=void 0;this.relations&&e.each(this.relations,function(a){if(f[a.key]!=void 0){var b=!f||!f[a.key]?null:e.isFunction(f[a.key])?f[a.key]():
f[a.key];a.relatedModel&&e.isString(a.relatedModel)&&(a.relatedModel=eval(a.relatedModel));a.collectionType&&e.isString(a.collectionType)&&(a.collectionType=eval(a.collectionType));var c=false;if(a.type===d.Many){if(a.collectionType&&!a.collectionType.prototype instanceof d.Collection)throw Error("collectionType must inherit from Backbone.Collection");if(!this.attributes[a.key]){this.attributes[a.key]=a.collectionType?new a.collectionType:this._createCollection(a.relatedModel);c=true}if(b instanceof
d.Collection)b=b.models;this.attributes[a.key].reset(b,g)}else if(a.type==d.One&&a.relatedModel){if(this.attributes[a.key]){var i={},j=!this.attributes[a.key]||!this.attributes[a.key].defaults?null:e.isFunction(this.attributes[a.key].defaults)?this.attributes[a.key].defaults():this.attributes[a.key].defaults;e.each(this.attributes[a.key].attributes,function(a,c){!e.has(b,c)&&(i[c]=j?j[c]:void 0)});this.attributes[a.key].set(i,{silent:true})}else{if(b instanceof d.AssociatedModel)return;this.attributes[a.key]=
new a.relatedModel;c=true}this.attributes[a.key].set(b,g)}this.attributes[a.key].off("all");this.attributes[a.key].on("all",function(){return this.trigger.apply(this,arguments)},this);c&&this.trigger("change:"+a.key,g);!h&&(h=[]);e.indexOf(h,a.key)===-1&&h.push(a.key)}},this);if(h){c={};for(b in f)e.indexOf(h,b)===-1&&(c[b]=f[b])}else c=f;return d.Model.prototype.set.call(this,c,g)}},_createCollection:function(b){var c;if(b&&b.prototype instanceof d.AssociatedModel){c=new d.Collection;c.model=b}else throw Error("type must inherit from Backbone.AssociatedModel");
return c},trigger:function(){if(!this.visited){this.visited=true;d.Model.prototype.trigger.apply(this,arguments);delete this.visited}return this},toJSON:function(){var b;if(!this.visited){this.visited=true;b=d.Model.prototype.toJSON.apply(this,arguments);this.relations&&e.each(this.relations,function(c){var d=this.attributes[c.key];if(d){aJson=d.toJSON();b[c.key]=e.isArray(aJson)?e.compact(aJson):aJson}},this);delete this.visited}return b},clone:function(){var b;if(!this.visited){this.visited=true;
b=d.Model.prototype.clone.apply(this,arguments);this.relations&&e.each(this.relations,function(c){if(this.attributes[c.key]){var e=b.attributes[c.key];if(e instanceof d.Collection){var f=c.collectionType?new c.collectionType:this._createCollection(c.relatedModel);e.each(function(b){(b=b.clone())&&f.add(b)});b.attributes[c.key]=f}else e instanceof d.Model&&(b.attributes[c.key]=e.clone())}},this);delete this.visited}return b}})})();
