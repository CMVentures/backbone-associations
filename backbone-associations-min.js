(function(){var f,h,q,l,m,r,n;"undefined"!==typeof require?(f=require("underscore"),h=require("backbone"),exports=module.exports=h):(f=window._,h=window.Backbone);q=h.Model;l=h.Collection;m=q.prototype;r="change add remove reset destroy sync error sort request".split(" ");h.Many="Many";h.One="One";n=h.AssociatedModel=q.extend({relations:void 0,_proxyCalls:void 0,get:function(b){return this.getAttr.apply(this,arguments)},set:function(b,a,c){var d,e,g;if(f.isObject(b)||b==null){d=b;c=a}else{d={};d[b]=
a}c||(c={});if(!d)return this;if(c.unset)for(g in d)d[g]=void 0;this.relations&&f.each(this.relations,function(a){var b=a.key,g=a.relatedModel,k=a.collectionType,i,p;if(d[b]){i=f.result(d,b);g&&f.isString(g)&&(g=eval(g));k&&f.isString(k)&&(k=eval(k));p=a.options?f.extend({},a.options,c):c;if(a.type===h.Many){if(k&&!k.prototype instanceof l)throw Error("collectionType must inherit from Backbone.Collection");if(i instanceof l)m.set.call(this,b,i,p);else if(this.attributes[b])this.attributes[b].reset(i,
p);else{a=k?new k:this._createCollection(g);a.add(i,p);m.set.call(this,b,a,p)}}else if(a.type===h.One&&g){a=i instanceof n?i:new g(i);m.set.call(this,b,a,p)}if((i=this.attributes[b])&&!i._proxyCallback){i._proxyCallback=function(){return this._bubbleEvent.call(this,b,arguments)};i.on("all",i._proxyCallback,this)}!e&&(e=[]);f.indexOf(e,b)===-1&&e.push(b)}},this);if(e){b={};for(g in d)f.indexOf(e,g)===-1&&(b[g]=d[g])}else b=d;return m.set.call(this,b,c)},_bubbleEvent:function(b,a){var c=a[0].split(":"),
d=c[0],e=a[1],g=-1,h=this.attributes[b],o=h._proxyCalls,j;if(f.contains(r,d)){f.size(c)>1&&(j=c[1]);if(h instanceof l&&"change"===d&&e){var k=s(j),i=f.initial(k);(c=h.find(function(a){var b=a.get(k);return e===!(b instanceof n||b instanceof l)?a.get(i):b}))&&(g=h.indexOf(c))}j=b+(g!==-1?"["+g+"]":"")+(j?"."+j:"");a[0]=d+":"+j;if(o){if(d=f.find(o,function(a,b){return j.indexOf(b,j.length-b.length)!==-1}))return this}else o=h._proxyCalls={};o[j]=true}this.trigger.apply(this,a);j&&o&&delete o[j];return this},
_createCollection:function(b){var a=b;f.isString(a)&&(a=eval(a));if(a&&a.prototype instanceof n){b=new l;b.model=a}else throw Error("type must inherit from Backbone.AssociatedModel");return b},hasChanged:function(b){var a,c,d;if(!this.visitedHC){this.visitedHC=true;a=m.hasChanged.apply(this,arguments);if(!a&&this.relations)for(d=0;d<this.relations.length;++d){c=this.relations[d];if(c=this.attributes[c.key]){if(c instanceof l){c=c.filter(function(a){return a.hasChanged()===true});f.size(c)>0&&(a=true)}else a=
c.hasChanged&&c.hasChanged();if(a)break}}delete this.visitedHC}return!!a},changedAttributes:function(b){var a,c,d,e;if(!this.visited){this.visited=true;a=m.changedAttributes.apply(this,arguments);if(this.relations)for(e=0;e<this.relations.length;++e){c=this.relations[e];if(d=this.attributes[c.key])if(d instanceof l){d=f.filter(d.map(function(a){return a.changedAttributes()}),function(a){return!!a});f.size(d)>0&&(a[c.key]=d)}else d instanceof n&&d.hasChanged()&&(a[c.key]=d.toJSON())}delete this.visited}return!a?
false:a},previousAttributes:function(){var b,a,c,d;if(!this.visited){this.visited=true;b=m.previousAttributes.apply(this,arguments);this.relations&&f.each(this.relations,function(e){a=this.attributes[e.key];d=(c=b[e.key])?c.toJSON():void 0;c&&c==a?a instanceof n?b[e.key]=a.previousAttributes():a instanceof l&&(b[e.key]=a.map(function(a){return a.previousAttributes()})):c&&(b[e.key]=d)},this);delete this.visited}return b},previous:function(b){return this.previousAttributes()[b]},toJSON:function(b){var a,
c;if(!this.visited){this.visited=true;a=m.toJSON.apply(this,arguments);this.relations&&f.each(this.relations,function(d){var e=this.attributes[d.key];if(e){c=e.toJSON(b);a[d.key]=f.isArray(c)?f.compact(c):c}},this);delete this.visited}return a},clone:function(){return new this.constructor(this.toJSON())},getAttr:function(b,a){var c=this,d=s(b),e,g;a||(a=function(a,b){return a instanceof l&&f.isNumber(b)?a.at(b):a.attributes[b]});for(g=0;g<d.length;g++){e=d[g];if(!c)break;c=a.call(this,c,e,d)}return c}});
var s=function(b,a,c){if(f.isString(b)){a||(a=function(a){return a.match(/^\d+$/)?parseInt(a,10):a});return f.map(b.match(/[^\.\[\]]+/g)||[],a,c)}return b||[]}})();
