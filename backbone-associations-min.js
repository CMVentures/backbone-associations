(function(){var f,d;if(typeof window==="undefined"){f=require("underscore");d=require("backbone");exports=module.exports=d}else{f=window._;d=window.Backbone;exports=window}d.Many="Many";d.One="One";d.AssociatedModel=d.Model.extend({relations:undefined,set:function(b,c,e){var g,h;if(f.isObject(b)||b==null){g=b;e=c}else{g={};g[b]=c}e||(e={});if(!g)return this;if(e.unset)for(attr in g)g[attr]=void 0;this.relations&&f.each(this.relations,function(a){if(g[a.key]!=undefined){var i=l(g,a.key);a.relatedModel&&
f.isString(a.relatedModel)&&(a.relatedModel=eval(a.relatedModel));a.collectionType&&f.isString(a.collectionType)&&(a.collectionType=eval(a.collectionType));var j=false;if(a.type===d.Many){if(a.collectionType&&!a.collectionType.prototype instanceof d.Collection)throw Error("collectionType must inherit from Backbone.Collection");if(!this.attributes[a.key]){this.attributes[a.key]=a.collectionType?new a.collectionType:this._createCollection(a.relatedModel);j=true}if(i instanceof d.Collection)i=i.models;
this.attributes[a.key].reset(i,e)}else if(a.type==d.One&&a.relatedModel){if(this.attributes[a.key]){var m={},n=l(this.attributes[a.key],"defaults");f.each(this.attributes[a.key].attributes,function(o,k){!f.has(i,k)&&(m[k]=n?n[k]:void 0)});this.attributes[a.key].set(m,{silent:true})}else{if(i instanceof d.AssociatedModel)return this;this.attributes[a.key]=new a.relatedModel;j=true}this.attributes[a.key].set(i,e)}this.attributes[a.key].off("all");this.attributes[a.key].on("all",function(){return this.trigger.apply(this,
arguments)},this);j&&this.trigger("change:"+a.key,e);!h&&(h=[]);f.indexOf(h,a.key)===-1&&h.push(a.key)}},this);if(h){c={};for(b in g)if(f.indexOf(h,b)===-1)c[b]=g[b]}else c=g;return d.Model.prototype.set.call(this,c,e)},_createCollection:function(b){var c;if(b&&b.prototype instanceof d.AssociatedModel){c=new d.Collection;c.model=b}else throw Error("type must inherit from Backbone.AssociatedModel");return c},trigger:function(){if(!this.visited){this.visited=true;d.Model.prototype.trigger.apply(this,
arguments);delete this.visited}return this},toJSON:function(){var b;if(!this.visited){this.visited=true;b=d.Model.prototype.toJSON.apply(this,arguments);this.relations&&f.each(this.relations,function(c){var e=this.attributes[c.key];if(e){aJson=e.toJSON();b[c.key]=f.isArray(aJson)?f.compact(aJson):aJson}},this);delete this.visited}return b},clone:function(){var b;if(!this.visited){this.visited=true;b=d.Model.prototype.clone.apply(this,arguments);this.relations&&f.each(this.relations,function(c){if(this.attributes[c.key]){var e=
b.attributes[c.key];if(e instanceof d.Collection){var g=c.collectionType?new c.collectionType:this._createCollection(c.relatedModel);e.each(function(h){(h=h.clone())&&g.add(h)});b.attributes[c.key]=g}else if(e instanceof d.Model)b.attributes[c.key]=e.clone()}},this);delete this.visited}return b}});var l=function(b,c){if(!(b&&b[c]))return null;return f.isFunction(b[c])?b[c]():b[c]}})();
