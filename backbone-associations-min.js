(function(){var d,e;"undefined"===typeof window?(d=require("underscore"),e=require("backbone"),exports=module.exports=e):(d=window._,e=window.Backbone,exports=window);e.Many="Many";e.One="One";e.AssociatedModel=e.Model.extend({relations:void 0,set:function(a,b,h){var f,j;if(d.isObject(a)||a==null){f=a;h=b}else{f={};f[a]=b}h||(h={});if(!f)return this;if(h.unset)for(attr in f)f[attr]=void 0;this.relations&&d.each(this.relations,function(b){var c=b.key,a=b.relatedModel,g=b.collectionType;if(f[c]!=void 0){var i=
!f||!f[c]?null:d.isFunction(f[c])?f[c]():f[c];a&&d.isString(a)&&(a=eval(a));g&&d.isString(g)&&(g=eval(g));var k=false,l=b.options?d.extend({},b.options,h):h;if(b.type===e.Many){if(g&&!g.prototype instanceof e.Collection)throw Error("collectionType must inherit from Backbone.Collection");if(!this.attributes[c]){this.attributes[c]=g?new g:this._createCollection(a);k=true}if(i instanceof e.Collection)i=i.models;this.attributes[c].reset(i,l)}else if(b.type==e.One&&a){if(this.attributes[c]){var m={},n=
!this.attributes[c]||!this.attributes[c].defaults?null:d.isFunction(this.attributes[c].defaults)?this.attributes[c].defaults():this.attributes[c].defaults;d.each(this.attributes[c].attributes,function(b,a){!d.has(i,a)&&(m[a]=n?n[a]:void 0)});this.attributes[c].set(m,{silent:true})}else{if(i instanceof e.AssociatedModel)return this;this.attributes[c]=new a;k=true}this.attributes[c].set(i,l)}this.attributes[c].off("all");this.attributes[c].on("all",function(){return this.trigger.apply(this,arguments)},
this);k&&this.trigger("change:"+c,this,this.get(c),l);!j&&(j=[]);d.indexOf(j,c)===-1&&j.push(c)}},this);if(j){b={};for(a in f)d.indexOf(j,a)===-1&&(b[a]=f[a])}else b=f;return e.Model.prototype.set.call(this,b,h)},_createCollection:function(a){var b=a;d.isString(b)&&(b=eval(b));if(b&&b.prototype instanceof e.AssociatedModel){a=new e.Collection;a.model=b}else throw Error("type must inherit from Backbone.AssociatedModel");return a},trigger:function(){if(!this.visited){this.visited=true;e.Model.prototype.trigger.apply(this,
arguments);delete this.visited}return this},toJSON:function(){var a;if(!this.visited){this.visited=true;a=e.Model.prototype.toJSON.apply(this,arguments);this.relations&&d.each(this.relations,function(b){var e=this.attributes[b.key];if(e){aJson=e.toJSON();a[b.key]=d.isArray(aJson)?d.compact(aJson):aJson}},this);delete this.visited}return a},clone:function(){var a;if(!this.visited){this.visited=true;a=e.Model.prototype.clone.apply(this,arguments);this.relations&&d.each(this.relations,function(b){if(this.attributes[b.key]){var d=
a.attributes[b.key];if(d instanceof e.Collection){var f=b.collectionType?new b.collectionType:this._createCollection(b.relatedModel);d.each(function(a){(a=a.clone())&&f.add(a)});a.attributes[b.key]=f}else d instanceof e.Model&&(a.attributes[b.key]=d.clone())}},this);delete this.visited}return a}})})();
